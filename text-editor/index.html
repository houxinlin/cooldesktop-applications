<!DOCTYPE html>
<html>

<head>
    <base href="/desktop/webapplication/100000/" />

    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="lib/monaco-editor/min/vs/editor/editor.main.css" />
    <style>
        #container {
            position: fixed;
            left: 0px;
            top: 0px;
            right: 0px;
            bottom: 0px;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <script>
        var require = { paths: { vs: '/desktop/webapplication/100000/lib/monaco-editor/min/vs' } };
        // var require = { paths: { vs: './lib/monaco-editor/min/vs' } };
    </script>
    <script src="lib/monaco-editor/min/vs/loader.js"></script>
    <script src="lib/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
    <script src="lib/monaco-editor/min/vs/editor/editor.main.js"></script>

    <script>
        let editor = null
        function loadText() {
            const params = new URLSearchParams(window.location.search)
            editFilePath = params.get("path")
            fetch('/desktop/api/file/text/content/get?path=' + editFilePath)
                .then(response => response.json())
                .then(data => {
                    loadEditor(data.data.content, data.data.type)
                    // document.getElementById("editor").style.display = "block"
                    // editor.getSession().setMode("ace/mode/" + data.data.type);
                    // editor.setValue(data.data.content, 1)
                });
        }
        function saveContent() {
            const data = { path: editFilePath, content: editor.getValue() };
            var params = Object.keys(data).map(function (key) {
                return encodeURIComponent(key) + "=" + encodeURIComponent(data[key]);
            }).join("&");

            fetch('/desktop/api/file/text/content/set', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params
            }).then(response => response.json())
                .then(data => {
                    if (data.status == 0) {
                        window.parent.postMessage({ "action": "notification", "param": { "message": "保存成功", "type": "success" } }, "*")
                    }
                });
        }
        function loadEditor(value, type) {
            if (editor != null) {
                editor.setValue(value)
                return
            }
            editor = monaco.editor.create(document.getElementById('container'), {
                value: value,
                language: type,
                lineNumbers: 'on',
                roundedSelection: false,
                scrollBeyondLastLine: false,
                readOnly: false,
                theme: 'vs-dark'
            });
        }
        window.addEventListener("message", receiveMessage, true);
        function receiveMessage(event) {
            if (event.data['eventName'] == "windowEvent" && event.data["detailName"] == "sizeChange") {
                editor.layout()
            }
            if (event.data['eventName'] == "menuEvent" && event.data["path"] == "保存") {
                saveContent()
            }
        }
        loadText()

    </script>
</body>

</html>